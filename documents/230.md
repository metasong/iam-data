# Angular Lifecycle hooks
---
author: Jason Song <metaseed@gmail.com>
version: 1.0.0
tag: [Angular]
subPage: []
enable: [toc]

---
> logic:   
> test: packages\core\test\acceptance\lifecycle_spec.ts
* all onChange/onInit/doCheck hooks are related change detection of Angular. change detection work on component template and is desitned for template.
* change detection has 2 parts: `onChange` has all changes detected by Angular change detection, then `doCheck` for addtional code detected by the user code.
* onChange/onInit: onInit is only triggers after the first OnChange.
* onChange/onInit only happens when there are changes, doCheck happens on every change detection round even without change from input
* order:  element's component and directives then element's content then element's template elements
### change detection running order of a component template
```html {2, 3-4}
<parent><!-- 0: parent element's component change detection --> <!--4: components/directives inside host's templete -->
  <comp> <!--1: element's component changes detection, the first content child of parent--> <!-- 3: components/directives inside component template -->
    <!-- 2: all components/directives inside contents -->
    <content1></content1> 
    <content2></content2>
  </comp>
  <comp1></comp1> <!-- 3: sibling element --> <!-- 5: components/directives inside sibling element component-template -->
</parent>
```
## lifecycle/change detection hooks trigger order

![](https://lh4.googleusercontent.com/jqfQIpB5PJcoOn8n9fMW466u69Fs-kS4pKMzr3nKPmLRj_T730J9MB3kBRfaI9A_T3T5PFYOsjL0lSJkl_NifKbzhOJgkZKU5bQmiZhXwz8Tcu_uT6rsSlA8gFF5hl-YBRybh0RA)

1. **constructor**: directive/component created
1. **@input property setter**: the directive's input property set one by one, we could handle change in the property setter just for that @input property
1. change detection runs on **element's component**
    1. ngOnChanges that happens after all input properties are set and the parameter contains all the changes of inputs, we could handle changes that related to several inputs here.
        > SimpleChanges: SimpleChanges SimpleChange.previousChange === undefined means the first time, and there is also SimpleChange.firstTime === true
    1. ngOnInit just happens the first time after ngOnChanges, means directive/component created and Input properties set, means fully initiallized ->
    1. ngDoCheck: to dectect additional changes that may happens and can not detected by Angular change dectection (not from input value changes, any others?). i.e. in async pipe from the observerable 
        > when to use: to detect additonal changes. use cases:  
        > 1. ngSwitchCase: ngOnChange could only caught change of the case expression result, but we need to eveluate expresion on ngSwitch too. we need to compare the result from 2 expressions. in _matchCase of ngSwitch: after all matches tested but still no match, use the default case.
        > 1. ngClass need to compare the array or object, default change detector only compare object reference, so we use IterableDiffers and KeyValueDiffers do the compareration.
        > 1. ngForOf: trackby the iterable changes to create/remove/move subViews, ngForTrackBy function map an item to a value to do comparation for changes, default use reference comparation.
        
1. change detection runs on component **element's content inside the host template**
    1. afterContentInit: get notified after the first time of all contents' change detection: onChange/onInit
       > content is a part of view inside the host-component template, and it's the children of the component element.
    1. afterContentChecked: get notified after all contents' additional check happened: doCheck
1. then go inside the **component template** 
   1. afterViewInit: for all components/directives inside the component template, the first time change detection has run.
      > afterViewInit: means the first change dection round related to me(me and the ui subtree of me ) has complete, so the @ViewChild(ren) @ContentChild(ren) queries that with static: false(default), would get its value assigned.(static: true, query and value assigned after create, that means at OnInit we could get the value), fire 1 time at the first change detection round
    1. afterViewChecked: for all components/directives inside the component template,  additional checks from their code have run. fire at every change detection round

need to look hook sequence between the parent and child.

### change detection happens on elements one by one
> triggered function call on one change detection of the element: onChange(onInit), doCheck
```js
  let log: string[] = [];

  class AllHooks {
    id: number = -1;

    /** @internal */
    private _log(hook: string, id: number) {
      log.push(hook + id);
    }

    ngOnChanges() {
      this._log('onChanges', this.id);
    }
    ngOnInit() {
      this._log('onInit', this.id);
    }
    ngDoCheck() {
      this._log('doCheck', this.id);
    }
    ngAfterContentInit() {
      this._log('afterContentInit', this.id);
    }
    ngAfterContentChecked() {
      this._log('afterContentChecked', this.id);
    }
    ngAfterViewInit() {
      this._log('afterViewInit', this.id);
    }
    ngAfterViewChecked() {
      this._log('afterViewChecked', this.id);
    }
  }

  @Directive({selector: 'div'})
  class DirA extends AllHooks {
    @Input('a') override id: number = 0;
  }

  @Directive({selector: 'div'})
  class DirB extends AllHooks {
    @Input('b') override id: number = 0;
  }

  @Directive({selector: 'div'})
  class DirC extends AllHooks {
    @Input('c') override id: number = 0;
  }

  @Component({selector: 'app-comp', template: '<div [a]="1" [b]="2" [c]="3"></div>'})
  class AppComp {
  }

  TestBed.configureTestingModule({declarations: [AppComp, DirA, DirB, DirC]});
  const fixture = TestBed.createComponent(AppComp);
  fixture.detectChanges();

  expect(log).toEqual([
    'onChanges1',
    'onInit1',
    'doCheck1',
    'onChanges2',
    'onInit2',
    'doCheck2',
    'onChanges3',
    'onInit3',
    'doCheck3',
    'afterContentInit1',
    'afterContentChecked1',
    'afterContentInit2',
    'afterContentChecked2',
    'afterContentInit3',
    'afterContentChecked3',
    'afterViewInit1',
    'afterViewChecked1',
    'afterViewInit2',
    'afterViewChecked2',
    'afterViewInit3',
    'afterViewChecked3'
  ]);
});
```
## Note




## Refrences
https://angular.io/guide/lifecycle-hooks

